# Інсталяція тестового шлюзу безпечного обміну

___

## Процесс інсталяції

- [Інсталяція тестового шлюзу безпечного обміну](#інсталяція-тестового-шлюзу-безпечного-обміну)
  - [Процесс інсталяції](#процесс-інсталяції)
    - [1. Інсталяція операційної системи {#install-1}](#1-інсталяція-операційної-системи-install-1)
    - [2. Налаштування мережі {#install-2}](#2-налаштування-мережі-install-2)
    - [3. Додавання репозиторія з пакетами СЕВДЕІР {#install-3}](#3-додавання-репозиторія-з-пакетами-севдеір-install-3)
    - [4. Додавання GPG ключа для репозиторія {#install-4}](#4-додавання-gpg-ключа-для-репозиторія-install-4)
    - [5. Додавання облікового запису адміністратора веб-сервісів {#install-5}](#5-додавання-облікового-запису-адміністратора-веб-сервісів-install-5)
    - [6. Налаштування локалі {#install-6}](#6-налаштування-локалі-install-6)
    - [7. Встановлення пакета uxp-securityserver-ua та залежностей {#install-7}](#7-встановлення-пакета-uxp-securityserver-ua-та-залежностей-install-7)
    - [8. Завантаження ліцензій для шлюзу безпечного обміну {#install-8}](#8-завантаження-ліцензій-для-шлюзу-безпечного-обміну-install-8)

### 1. Інсталяція операційної системи {#install-1}

Тестовий шлюз безпечного обміну функціонує на базі операційної системи Ubuntu Server 16.04.5 x64. Інсталяція операційної системи виконується згідно додатку А цієї інструкції.

### 2. Налаштування мережі {#install-2}

Після інсталяції операційної системи необхідно налаштувати мережеві параметри. Рекомендуємо це зробити для всіх компонентів тестового та промислового середовища, згідно спланованих мережевих адрес.

Налаштування IP-адреси в операційній системі Ubuntu Server 16.04 здійснюється у файлі /etc/network/interfaces:

```bash
sudo nano /etc/network/interfaces
```

Приклад налаштувань для статичної IP-адреси має наступний вигляд:

<pre class="pre-file-1">
    auto ens33
    iface ens33 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    gateway 192.168.1.1
    dns-nameservers 192.168.1.1 8.8.8.8
</pre>

- **ens33** - системне ім’я мережевого адаптеру, що налаштовується. Дізнатися його можна за допомогою команди `dmesg | grep eth`,
- **static** - встановлення статичної IP-адреси. У випадку, якщо ви налаштовуєте прив’язку IP-адреси за DHCP, замість static необхідно встановити dhcp і всі інші параметри не налаштовуються,
- **address** - це IP-адреса, яка буде встановлена для цього мережевого адаптера,
- **netmask** - це маска підмережі,
- **gateway** - це IP-адреса основного шлюза,
- **dns-nameservers** - IP-адреси сервері імен, які використовуватимуться для визначення IP-адрес за dns-іменами вузлів мережі.
  
> Конкретні значення у вашому випадку можуть бути іншими.

Крім цього, **якщо віртуальна машина була клонована з метою пришвидшення процесу інсталяції**, необхідно змінити ім’я вузла у наступних файлах: **/etc/hosts** та **/etc/hostname**.

Також потрібно відключити функції автоматичного оновлення пакетів. для цього відкрити файл /etc/apt/apt.conf.d/10periodic за допомогою команди:

```bash
sudo nano /etc/apt/apt.conf.d/10periodic
```

та встановити параметр APT::Periodic::UpdatePackage-Lists у значення 0:

<pre class="pre-file-1">
    APT::Periodic::Update-Packages-Lists "0";
</pre>

Відкрити файл /etc/update-manager/release-upgrades:

```bash
sudo nano /etc/update-manager/release-upgrades
```

та встановити параметр Prompt у значення never:

<pre class="pre-file-1">
    Prompt=never
</pre>

Після збереження змін у файлах, необхідно перезавантажити операційну систему командою:

```bash
sudo shutdown -r now
```

### 3. Додавання репозиторія з пакетами СЕВДЕІР {#install-3}

Підключіться до консолі (командного інтерфейсу) операційної системи шлюзу безпечного обміну, наприклад, за допомогою наступної команди:

> `ssh <ADMIN_USER>@<Your-security-server-IP>`

- `<ADMIN_USER>` - це логін адміністратора безпеки операційної системи шлюзу безпечного обміну, який створено під час інсталяції операційної системи (згідно додатку А до цієї інструкції),
- `<Your-security-server-IP>` - це IP-адреса шлюзу безпечного обміну.

> **Примітка.** Зверніть увагу, що при введенні паролю (password), символи, що ви вводите, не відображаються на екрані - це нормально.

![Вхід на сервер][trembita-test-install-1]

> **Примітка.** При використанні команди sudo перший раз після входу користувача в операційну систему вас запитає пароль цього користувача для підтвердження адміністративних повноважень у системі.

Для додавання репозиторія з пакетами СЕВДЕІР необхідно закоментувати всі рядки у файлі */etc/apt/sources.list* (вставляючи символ # на початку кожного рядку) та додати наступні нові рядки в кінці файлу:

<pre class="pre-file-1">
    deb http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/ member/
    deb http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/ member/
</pre>

Швидко це зробити можна за допомогою наступних двох команд. Перша додає символ коментування # до кожного непустого рядку, друга додає новий необхідний рядок з посиланням до репозиторію в кінець файлу.

```bash
sudo sed -i 's/^[A-Za-z0-9]/#&/' /etc/apt/sources.list
echo 'deb http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/ member/' | sudo tee -a /etc/apt/sources.list
echo 'deb http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/ member/' | sudo tee -a /etc/apt/sources.list
```

Перевірити результат можна за допомогою текстового редактора nano:

```bash
nano /etc/apt/sources.list
```

![Команди][trembita-test-install-2]

Для виходу з редактору використовується комбінація клавіш “Ctrl + X”. Якщо були внесені зміни, то потрібно натиснути клавішу “Y” для збереження змін, або “N” для відміни.

### 4. Додавання GPG ключа для репозиторія {#install-4}

Для встановлення програмного забезпечення з репозиторію СЕВДЕІР потрібно завантажити та додати в систему GPG ключ репозиторію.

Для цього виконайте наступні команди:

```bash
sudo wget -O - http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/pubkey.txt | sudo apt-key add -
sudo wget -O - http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/pubkey.txt | sudo apt-key add -
```

Якщо команда виконана успішно, то буде виведене повідомлення “ОК”.

### 5. Додавання облікового запису адміністратора веб-сервісів {#install-5}

Шлюз безпечного обміну використовує локальних користувачів і групи операційної системи для контролю доступу до веб-інтерфейсу адміністрування шлюзу безпечного обміну. Потрібно створити новий обліковий запис, який буде використовуватись для входу в веб-інтерфейс шлюзу безпечного обміну - це обліковий запис адміністратора веб-сервісів з логіном *uxpadmin*.

Для цього виконайте наступні команди:

```bash
sudo useradd -M -N uxpadmin
sudo chsh -s /bin/false uxpadmin
sudo passwd uxpadmin
```

Введіть пароль нового користувача двічі.

### 6. Налаштування локалі {#install-6}

В операційній системі шлюзу безпечного обміну має бути встановлена локаль en_US.UTF-8. Для встановлення локалі виконайте наступну команду:

```bash
echo 'LC_ALL=en_US.UTF-8' | sudo tee -a /etc/environment
```

Перезавантажте змінні оточення наступною командою (зверніть увагу на наявність пробілу після першої крапки):

```bash
. /etc/environment
```

### 7. Встановлення пакета uxp-securityserver-ua та залежностей {#install-7}

Для встановлення програмного забезпечення UXP Security Server для шлюзу безпечного обміну  використовується команда *apt.* Перед встановленням потрібно оновити список доступних пакетів з репозиторію СЕВДЕІР.

Для встановлення зазначеного програмного забезпечення виконайте наступні команди:

```bash
sudo apt update
sudo apt install -y uxp-securityserver-ua
```

Під час встановлення необхідно ввести ім’я облікового запису (логін) адміністратора веб-сервісів, який буде адмініструвати функціонал шлюзу безпечного обміну - вводимо *uxpadmin*, якого ви створили на шлюзі безпечного обміну на одному з попередніх кроків:

![Конфігурування][trembita-test-install-3]

Цей користувач використовується для входу в веб-інтерфейс адміністрування шлюзу безпечного обміну.

Наступним кроком є внесення параметру використання пам’яті metaspace.

```bash
sudo echo 'SIGNER_PARAMS="${SIGNER_PARAMS} -XX:MaxMetaspaceSize=70m"' >> /etc/uxp/services/local.conf
```

### 8. Завантаження ліцензій для шлюзу безпечного обміну {#install-8}

Виконайте команду для перевірки стану виконання встановлених компонентів програмного забезпечення UXP Security Server:

```bash
sudo systemctl list-units | grep "uxp"
```

Список сервісів, які мають бути завантажені (loaded):

<pre class="pre-file-1">
uxp-confclient.service
uxp-jetty.service
uxp-monitor.service
uxp-proxy.service
uxp-signer.service
uxp-uaic.service     (якщо встановлений модуль контролю цілісності)
</pre>

Для роботи компоненту UXP Security Server потрібна діюча ліцензія для тестового середовища. UXP Security Server не працюватиме без діючого файлу ліцензії. Якщо спробуєте відкрити веб-інтерфейс, то побачите сторінку з помилкою "400: Bad Gateway" - ця сторінка відображається сервісом Nginx автоматично, коли UXP Security Server не може бути запущений. 

Файли ліцензії надаються Адміністратором СЕВДЕІР Учаснику разом з файлами якоря конфігурації тестового та промислового середовища (файли configuration anchor) відповідно до Регламенту системи електронної взаємодії державних електронних інформаційних ресурсів.

Завантажте файл ліцензії тестового середовища *member.test.license.lic* до тестового шлюзу безпечного обміну у домашню директорію адміністратора безпеки *secadmin.*

> Примітка. Завантаження файлу ліцензії здійснюється адміністратором локальних компонентів з робочої станції адміністратора за допомогою утиліт, що працюють за протоколом SCP, наприклад, scp або WinSCP.

Змініть назву файлу ліцензії на *license.lic* та перемістіть у наступне місце файлової системи шлюзу безпечного обміну: */etc/uxp/* за допомогою команди:

```bash
sudo mv member.test.license.lic /etc/uxp/license.lic
```

Після установки ліцензії UXP Security Server автоматично визначить наявність файлу з ліцензією і запустить всі необхідні служби (через декілька хвилин, повідомлення веб-інтерфейсу зміниться).

[trembita-test-install-1]: /assets/images/trembita-test-install-1.png  "Logo Title Text 2"
[trembita-test-install-2]: /assets/images/trembita-test-install-2.png  "Logo Title Text 2"
[trembita-test-install-3]: /assets/images/trembita-test-install-3.png  "Logo Title Text 2"
