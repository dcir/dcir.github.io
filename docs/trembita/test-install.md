# Інсталяція тестового шлюзу безпечного обміну

___

## Процесс інсталяції

- [Інсталяція тестового шлюзу безпечного обміну](#інсталяція-тестового-шлюзу-безпечного-обміну)
  - [Процесс інсталяції](#процесс-інсталяції)
    - [1. Інсталяція операційної системи {#install-1}](#1-інсталяція-операційної-системи-install-1)
    - [2. Налаштування мережі {#install-2}](#2-налаштування-мережі-install-2)
    - [3. Додавання репозиторія з пакетами СЕВДЕІР {#install-3}](#3-додавання-репозиторія-з-пакетами-севдеір-install-3)
    - [4. Додавання GPG ключа для репозиторія {#install-4}](#4-додавання-gpg-ключа-для-репозиторія-install-4)
    - [5. Додавання облікового запису адміністратора веб-сервісів {#install-5}](#5-додавання-облікового-запису-адміністратора-веб-сервісів-install-5)
    - [6. Налаштування локалі {#install-6}](#6-налаштування-локалі-install-6)
    - [7. Встановлення пакета uxp-securityserver-ua та залежностей {#install-7}](#7-встановлення-пакета-uxp-securityserver-ua-та-залежностей-install-7)
    - [8. Завантаження ліцензій для шлюзу безпечного обміну {#install-8}](#8-завантаження-ліцензій-для-шлюзу-безпечного-обміну-install-8)
    - [9. Встановлення підтримки захищених носіїв особистих ключів (апаратних токенів)](#9-встановлення-підтримки-захищених-носіїв-особистих-ключів-апаратних-токенів)

### 1. Інсталяція операційної системи {#install-1}

Тестовий шлюз безпечного обміну функціонує на базі операційної системи Ubuntu Server 16.04.5 x64. Інсталяція операційної системи виконується згідно додатку А цієї інструкції.

### 2. Налаштування мережі {#install-2}

Після інсталяції операційної системи необхідно налаштувати мережеві параметри. Рекомендуємо це зробити для всіх компонентів тестового та промислового середовища, згідно спланованих мережевих адрес.

Налаштування IP-адреси в операційній системі Ubuntu Server 16.04 здійснюється у файлі /etc/network/interfaces:

```bash
sudo nano /etc/network/interfaces
```

Приклад налаштувань для статичної IP-адреси має наступний вигляд:

<pre class="pre-file-1">
    auto ens33
    iface ens33 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    gateway 192.168.1.1
    dns-nameservers 192.168.1.1 8.8.8.8
</pre>

- **ens33** - системне ім’я мережевого адаптеру, що налаштовується. Дізнатися його можна за допомогою команди `dmesg | grep eth`,
- **static** - встановлення статичної IP-адреси. У випадку, якщо ви налаштовуєте прив’язку IP-адреси за DHCP, замість static необхідно встановити dhcp і всі інші параметри не налаштовуються,
- **address** - це IP-адреса, яка буде встановлена для цього мережевого адаптера,
- **netmask** - це маска підмережі,
- **gateway** - це IP-адреса основного шлюза,
- **dns-nameservers** - IP-адреси сервері імен, які використовуватимуться для визначення IP-адрес за dns-іменами вузлів мережі.
  
> Конкретні значення у вашому випадку можуть бути іншими.

Крім цього, **якщо віртуальна машина була клонована з метою пришвидшення процесу інсталяції**, необхідно змінити ім’я вузла у наступних файлах: **/etc/hosts** та **/etc/hostname**.

Також потрібно відключити функції автоматичного оновлення пакетів. для цього відкрити файл /etc/apt/apt.conf.d/10periodic за допомогою команди:

```bash
sudo nano /etc/apt/apt.conf.d/10periodic
```

та встановити параметр APT::Periodic::UpdatePackage-Lists у значення 0:

<pre class="pre-file-1">
    APT::Periodic::Update-Packages-Lists "0";
</pre>

Відкрити файл /etc/update-manager/release-upgrades:

```bash
sudo nano /etc/update-manager/release-upgrades
```

та встановити параметр Prompt у значення never:

<pre class="pre-file-1">
    Prompt=never
</pre>

Після збереження змін у файлах, необхідно перезавантажити операційну систему командою:

```bash
sudo shutdown -r now
```

### 3. Додавання репозиторія з пакетами СЕВДЕІР {#install-3}

Підключіться до консолі (командного інтерфейсу) операційної системи шлюзу безпечного обміну, наприклад, за допомогою наступної команди:

> `ssh <ADMIN_USER>@<Your-security-server-IP>`

- `<ADMIN_USER>` - це логін адміністратора безпеки операційної системи шлюзу безпечного обміну, який створено під час інсталяції операційної системи (згідно додатку А до цієї інструкції),
- `<Your-security-server-IP>` - це IP-адреса шлюзу безпечного обміну.

> **Примітка.** Зверніть увагу, що при введенні паролю (password), символи, що ви вводите, не відображаються на екрані - це нормально.

![Вхід на сервер][trembita-test-install-1]

> **Примітка.** При використанні команди sudo перший раз після входу користувача в операційну систему вас запитає пароль цього користувача для підтвердження адміністративних повноважень у системі.

Для додавання репозиторія з пакетами СЕВДЕІР необхідно закоментувати всі рядки у файлі */etc/apt/sources.list* (вставляючи символ # на початку кожного рядку) та додати наступні нові рядки в кінці файлу:

<pre class="pre-file-1">
    deb http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/ member/
    deb http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/ member/
</pre>

Швидко це зробити можна за допомогою наступних двох команд. Перша додає символ коментування # до кожного непустого рядку, друга додає новий необхідний рядок з посиланням до репозиторію в кінець файлу.

```bash
sudo sed -i 's/^[A-Za-z0-9]/#&/' /etc/apt/sources.list
echo 'deb http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/ member/' | sudo tee -a /etc/apt/sources.list
echo 'deb http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/ member/' | sudo tee -a /etc/apt/sources.list
```

Перевірити результат можна за допомогою текстового редактора nano:

```bash
nano /etc/apt/sources.list
```

![Команди][trembita-test-install-2]

Для виходу з редактору використовується комбінація клавіш “Ctrl + X”. Якщо були внесені зміни, то потрібно натиснути клавішу “Y” для збереження змін, або “N” для відміни.

### 4. Додавання GPG ключа для репозиторія {#install-4}

Для встановлення програмного забезпечення з репозиторію СЕВДЕІР потрібно завантажити та додати в систему GPG ключ репозиторію.

Для цього виконайте наступні команди:

```bash
sudo wget -O - http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/pubkey.txt | sudo apt-key add -
sudo wget -O - http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/pubkey.txt | sudo apt-key add -
```

Якщо команда виконана успішно, то буде виведене повідомлення “ОК”.

### 5. Додавання облікового запису адміністратора веб-сервісів {#install-5}

Шлюз безпечного обміну використовує локальних користувачів і групи операційної системи для контролю доступу до веб-інтерфейсу адміністрування шлюзу безпечного обміну. Потрібно створити новий обліковий запис, який буде використовуватись для входу в веб-інтерфейс шлюзу безпечного обміну - це обліковий запис адміністратора веб-сервісів з логіном *uxpadmin*.

Для цього виконайте наступні команди:

```bash
sudo useradd -M -N uxpadmin
sudo chsh -s /bin/false uxpadmin
sudo passwd uxpadmin
```

Введіть пароль нового користувача двічі.

### 6. Налаштування локалі {#install-6}

В операційній системі шлюзу безпечного обміну має бути встановлена локаль en_US.UTF-8. Для встановлення локалі виконайте наступну команду:

```bash
echo 'LC_ALL=en_US.UTF-8' | sudo tee -a /etc/environment
```

Перезавантажте змінні оточення наступною командою (зверніть увагу на наявність пробілу після першої крапки):

```bash
. /etc/environment
```

### 7. Встановлення пакета uxp-securityserver-ua та залежностей {#install-7}

Для встановлення програмного забезпечення UXP Security Server для шлюзу безпечного обміну  використовується команда *apt.* Перед встановленням потрібно оновити список доступних пакетів з репозиторію СЕВДЕІР.

Для встановлення зазначеного програмного забезпечення виконайте наступні команди:

```bash
sudo apt update
sudo apt install -y uxp-securityserver-ua
```

Під час встановлення необхідно ввести ім’я облікового запису (логін) адміністратора веб-сервісів, який буде адмініструвати функціонал шлюзу безпечного обміну - вводимо *uxpadmin*, якого ви створили на шлюзі безпечного обміну на одному з попередніх кроків:

![Конфігурування][trembita-test-install-3]

Цей користувач використовується для входу в веб-інтерфейс адміністрування шлюзу безпечного обміну.

Наступним кроком є внесення параметру використання пам’яті metaspace.

```bash
sudo echo 'SIGNER_PARAMS="${SIGNER_PARAMS} -XX:MaxMetaspaceSize=70m"' >> /etc/uxp/services/local.conf
```

### 8. Завантаження ліцензій для шлюзу безпечного обміну {#install-8}

Виконайте команду для перевірки стану виконання встановлених компонентів програмного забезпечення UXP Security Server:

```bash
sudo systemctl list-units | grep "uxp"
```

Список сервісів, які мають бути завантажені (loaded):

<pre class="pre-file-1">
uxp-confclient.service
uxp-jetty.service
uxp-monitor.service
uxp-proxy.service
uxp-signer.service
uxp-uaic.service     (якщо встановлений модуль контролю цілісності)
</pre>

Для роботи компоненту UXP Security Server потрібна діюча ліцензія для тестового середовища. UXP Security Server не працюватиме без діючого файлу ліцензії. Якщо спробуєте відкрити веб-інтерфейс, то побачите сторінку з помилкою "400: Bad Gateway" - ця сторінка відображається сервісом Nginx автоматично, коли UXP Security Server не може бути запущений. 

Файли ліцензії надаються Адміністратором СЕВДЕІР Учаснику разом з файлами якоря конфігурації тестового та промислового середовища (файли configuration anchor) відповідно до Регламенту системи електронної взаємодії державних електронних інформаційних ресурсів.

Завантажте файл ліцензії тестового середовища *member.test.license.lic* до тестового шлюзу безпечного обміну у домашню директорію адміністратора безпеки *secadmin.*

> Примітка. Завантаження файлу ліцензії здійснюється адміністратором локальних компонентів з робочої станції адміністратора за допомогою утиліт, що працюють за протоколом SCP, наприклад, scp або WinSCP.

Змініть назву файлу ліцензії на *license.lic* та перемістіть у наступне місце файлової системи шлюзу безпечного обміну: */etc/uxp/* за допомогою команди:

```bash
sudo mv member.test.license.lic /etc/uxp/license.lic
```

Після установки ліцензії UXP Security Server автоматично визначить наявність файлу з ліцензією і запустить всі необхідні служби (через декілька хвилин, повідомлення веб-інтерфейсу зміниться).

### 9. Встановлення підтримки захищених носіїв особистих ключів (апаратних токенів)

Особисті ключі електронної печатки та шифрування знаходяться на захищеному носії особистих ключів (апаратний токен), який необхідно правильно підключити до віртуальної машини шлюзу безпечного обміну.

В першу чергу, підключіть апаратний токен (захищений носій особистих ключів) до фізичного обладнання - сервера, який забезпечує функціонування програмного забезпечення шлюзу безпечного обміну. Якщо використовується система віртуалізації на сервері - налаштуйте адресацію фізичного порту, до якого підключений апаратний токен, до віртуальної машини шлюзу безпечного обміну.

Правильність адресації можна перевірити через наявність інформації про ключі у операційній системі. Введіть наступну команду на шлюзі безпечного обміну:

```bash
sudo dmesg | grep usb
```

![Списки ключів][trembita-test-install-4]

Приклад. З виводу команди видно, що в системі присутні два електронних ключа - Product: IIT E.Key Crystal-1 та  Product: E.Key Almaz-1C відповідно  “Алмаз-1К” та “Кристал-1”.

Для того, щоб шлюз безпечного обміну мав можливість працювати з АЦСК, що видав сертифікати, необхідно додати інформацію про нього у спеціальний файл наступною командою:

```bash
sudo nano /etc/uxp/uac/osplm.ini
```

Знайдіть розділ (у квадратних дужках визначаються розділи) з налаштуваннями CMP-сервісу та встановіть параметри доступу:

<pre class="pre-file-1">
[\SOFTWARE\Institute of Informational Technologies\Certificate Authority-1.3\End User\CMP]
Use=1
CommonName=
Address=ca.informjust.ua
Port=80
</pre>

де у поле *Address* вказуємо адресу до сервісу CMP АЦСК, що видав ваші сертифікати (наприклад, ca.informjust.ua або ca.iit.com.ua). Зазначену адресу може надати ваш надавач електронних довірчих послуг. Також, необхідно встановити параметр *Use=1*.

Приклад результату модифікації файлу:

![Модифікований файл токенів][trembita-test-install-5]

Скопіювати файли підтримки ключів:

```bash
cd
wget http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/pac/signer-uac-plugin-1.0.6.jar
wget -nc http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/pac/signer-uac-plugin-1.0.6.jar
wget http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/pac/EUSignJava.jar
wget -nc http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/pac/EUSignJava.jar
```

Виконати оновлення файлів:

```bash
sudo cp signer-uac-plugin-1.0.6.jar /usr/share/uxp/jlib/addon/signer/
sudo cp EUSignJava.jar /usr/share/uxp/jlib/addon/uac/EUSignJava.jar
```

У випадку, якщо тестове середовище розгорнути у повній відповідності до промислового, виконати наступні команди:

```bash
sudo /usr/share/uxp/uaic/scripts/_uxp-uaic-integritychecker.sh recalc exec
sudo uxp-ua-integritychecker.sh start_all
```

Для ключів ІІТ “Кристал-1” необхідно додатково створити файл:

```bash
sudo nano  /etc/udev/rules.d/80-uxp-iit-e-keys.rules
```

та прописати в ньому правила:

<pre class="pre-file-1">
SUBSYSTEM=="usb", ATTR{idVendor}=="03eb", ATTR{idProduct}=="9301", MODE="0660", GROUP="uxp" 
SUBSYSTEM=="usb", ATTR{idVendor}=="03eb", ATTR{idProduct}=="9308", MODE="0660", GROUP="uxp"
</pre>

Для ключів ІІТ “Алмаз-1К”, Автор “Secure Token 337” та Efit EfitKey необхідно встановити пакети підтримки електронних ключів операційною системою Linux а саме Ubuntu 16.04 Server 64bit:

```bash
sudo apt-get install pcscd libccid pcsc-tools libccid libpcsclite1 opensc
```

Також, для ключів Автор “Secure Token 337” необхідно встановити драйвер для 64-розрядної ОС Linux:

```bash
apt install av337p11d
```

Для використання в якості токену безпеки засіб ІІТ Гряда-301 необхідно до файлу /etc/uxp/uac/osplm.ini додати наступний блок параметрів:

<pre class="pre-file-1">
[\SOFTWARE\Institute of Informational Technologies\Key Medias\NCM Gryada-301]
[\SOFTWARE\Institute of Informational Technologies\Key Medias\NCM Gryada-301\Modules]
[\SOFTWARE\Institute of Informational Technologies\Key Medias\NCM Gryada-301\Modules\001]
OrderNumber=0
SN=001
Address=20.0.0.1
AddressMask=255.0.0.0
</pre>

- 001 - це серійний номер пристрою ІІТ Гряда-301,
- Address - це мережевий адрес пристрою,
- AddressMask - маска підмережі, у якій знаходиться пристрій.

При використанні захищеного носія EfitKey необхідно виконати наступні дії.

Для того щоб додати (включити) існуючий pcsc-пристрій (захищений носій EfitKey) до відповідного списку pcsc-пристроїв, що підтримуються системою, необхідно скорегувати файл Info.plist

```bash
sudo nano /usr/lib/pcsc/drivers/ifd-ccid.bundle/Contents/Info.plist
```

а саме здійснити наступні кроки: 

<pre class="pre-file-1">
1. Знайти строку "<key>ifdVendorID</key>" і після елементу "<array>" 
додати "<string>0xC1A6</string>"
2. Знайти строку "<key>ifdProductID</key>" і після елементу "<array>" 
додати "<string>0x0151</string>"
3. Знайти строку "<key>ifdFriendlyName</key>" і після елементу
"<array>" додати "<string>EfitTechnologies EfitKey</string>"
</pre>

Скопіювати бібліотеку драйверів libefitkeynxt.so до каталогу /usr/lib:

```bash
wget http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/pac/libefitkeynxt.so
wget -nc http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/pac/libefitkeynxt.so
sudo cp libefitkeynxt.so /usr/lib/
```

Для роботи libefitkeynxt.so и EfitKey необхідно мати запущений демон pcscd

Під’єднуємо захищений носій ключової інформації "ЕФІТ КЕЙ" та перевіряємо доступність носія в системі:

```bash
sudo pkcs11-tool -v --list-slots --module /usr/lib/libefitkeynxt.so
```

У випадку, якщо ключ доступний для системи, має бути виведено інформацію про нього. Наприклад:

![Приклад відображення Efit][trembita-test-install-6]

Після проведених дій обов’язково необхідно перезавантажити операційну систему:

```bash
sudo shutdown -r now
```

[trembita-test-install-1]: /assets/images/trembita-test-install-1.png  "Logo Title Text 2"
[trembita-test-install-2]: /assets/images/trembita-test-install-2.png  "Logo Title Text 2"
[trembita-test-install-3]: /assets/images/trembita-test-install-3.png  "Logo Title Text 2"
[trembita-test-install-4]: /assets/images/trembita-test-install-4.png  "Logo Title Text 2"
[trembita-test-install-5]: /assets/images/trembita-test-install-5.png  "Logo Title Text 2"
[trembita-test-install-6]: /assets/images/trembita-test-install-6.png  "Logo Title Text 2"
