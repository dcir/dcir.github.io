# Інсталяція тестового шлюзу безпечного обміну

___

## 3. Процесс інсталяції

- [Інсталяція тестового шлюзу безпечного обміну](#інсталяція-тестового-шлюзу-безпечного-обміну)
  - [3. Процесс інсталяції](#3-процесс-інсталяції)
    - [3.1. Інсталяція операційної системи {#install-1}](#31-інсталяція-операційної-системи-install-1)
    - [3.2. Налаштування мережі {#install-2}](#32-налаштування-мережі-install-2)
    - [3.3. Додавання репозиторія з пакетами СЕВДЕІР {#install-3}](#33-додавання-репозиторія-з-пакетами-севдеір-install-3)
    - [3.4. Додавання GPG ключа для репозиторія {#install-4}](#34-додавання-gpg-ключа-для-репозиторія-install-4)
    - [3.5. Додавання облікового запису адміністратора веб-сервісів {#install-5}](#35-додавання-облікового-запису-адміністратора-веб-сервісів-install-5)
    - [3.6. Налаштування локалі {#install-6}](#36-налаштування-локалі-install-6)
    - [3.7. Встановлення пакета uxp-securityserver-ua та залежностей {#install-7}](#37-встановлення-пакета-uxp-securityserver-ua-та-залежностей-install-7)
    - [3.8. Завантаження ліцензій для шлюзу безпечного обміну {#install-8}](#38-завантаження-ліцензій-для-шлюзу-безпечного-обміну-install-8)
    - [3.9. Встановлення підтримки захищених носіїв особистих ключів (апаратних токенів)](#39-встановлення-підтримки-захищених-носіїв-особистих-ключів-апаратних-токенів)
  - [4. Початкова конфігурація](#4-початкова-конфігурація)
    - [4.1. Ініціалізація шлюзу безпечного обміну](#41-ініціалізація-шлюзу-безпечного-обміну)
    - [4.2. Введення PIN-коду програмного токену](#42-введення-pin-коду-програмного-токену)
    - [4.3. Налаштування сервера позначок часу](#43-налаштування-сервера-позначок-часу)
  - [5. Реєстрація шлюзу безпечного обміну](#5-реєстрація-шлюзу-безпечного-обміну)
    - [5.1. Імпорт ключа підпису та шифрування для власника шлюзу безпечного обміну](#51-імпорт-ключа-підпису-та-шифрування-для-власника-шлюзу-безпечного-обміну)
    - [5.2. Створення ключа автентифікації для UXP Security Server](#52-створення-ключа-автентифікації-для-uxp-security-server)
    - [5.3 Генерація запиту на сертифікат (Certificate Signing Request (CSR)) для ключа автентифікації](#53-генерація-запиту-на-сертифікат-certificate-signing-request-csr-для-ключа-автентифікації)

### 3.1. Інсталяція операційної системи {#install-1}

Тестовий шлюз безпечного обміну функціонує на базі операційної системи Ubuntu Server 16.04.5 x64. Інсталяція операційної системи виконується згідно додатку А цієї інструкції.

### 3.2. Налаштування мережі {#install-2}

Після інсталяції операційної системи необхідно налаштувати мережеві параметри. Рекомендуємо це зробити для всіх компонентів тестового та промислового середовища, згідно спланованих мережевих адрес.

Налаштування IP-адреси в операційній системі Ubuntu Server 16.04 здійснюється у файлі /etc/network/interfaces:

```bash
sudo nano /etc/network/interfaces
```

Приклад налаштувань для статичної IP-адреси має наступний вигляд:

<pre class="pre-file-1">
    auto ens33
    iface ens33 inet static
    address 192.168.1.100
    netmask 255.255.255.0
    gateway 192.168.1.1
    dns-nameservers 192.168.1.1 8.8.8.8
</pre>

- **ens33** - системне ім’я мережевого адаптеру, що налаштовується. Дізнатися його можна за допомогою команди `dmesg | grep eth`,
- **static** - встановлення статичної IP-адреси. У випадку, якщо ви налаштовуєте прив’язку IP-адреси за DHCP, замість static необхідно встановити dhcp і всі інші параметри не налаштовуються,
- **address** - це IP-адреса, яка буде встановлена для цього мережевого адаптера,
- **netmask** - це маска підмережі,
- **gateway** - це IP-адреса основного шлюза,
- **dns-nameservers** - IP-адреси сервері імен, які використовуватимуться для визначення IP-адрес за dns-іменами вузлів мережі.
  
> Конкретні значення у вашому випадку можуть бути іншими.

Крім цього, **якщо віртуальна машина була клонована з метою пришвидшення процесу інсталяції**, необхідно змінити ім’я вузла у наступних файлах: **/etc/hosts** та **/etc/hostname**.

Також потрібно відключити функції автоматичного оновлення пакетів. для цього відкрити файл /etc/apt/apt.conf.d/10periodic за допомогою команди:

```bash
sudo nano /etc/apt/apt.conf.d/10periodic
```

та встановити параметр APT::Periodic::UpdatePackage-Lists у значення 0:

<pre class="pre-file-1">
    APT::Periodic::Update-Packages-Lists "0";
</pre>

Відкрити файл /etc/update-manager/release-upgrades:

```bash
sudo nano /etc/update-manager/release-upgrades
```

та встановити параметр Prompt у значення never:

<pre class="pre-file-1">
    Prompt=never
</pre>

Після збереження змін у файлах, необхідно перезавантажити операційну систему командою:

```bash
sudo shutdown -r now
```

### 3.3. Додавання репозиторія з пакетами СЕВДЕІР {#install-3}

Підключіться до консолі (командного інтерфейсу) операційної системи шлюзу безпечного обміну, наприклад, за допомогою наступної команди:

> `ssh <ADMIN_USER>@<Your-security-server-IP>`

- `<ADMIN_USER>` - це логін адміністратора безпеки операційної системи шлюзу безпечного обміну, який створено під час інсталяції операційної системи (згідно додатку А до цієї інструкції),
- `<Your-security-server-IP>` - це IP-адреса шлюзу безпечного обміну.

> **Примітка.** Зверніть увагу, що при введенні паролю (password), символи, що ви вводите, не відображаються на екрані - це нормально.

![Вхід на сервер][trembita-test-install-1]

> **Примітка.** При використанні команди sudo перший раз після входу користувача в операційну систему вас запитає пароль цього користувача для підтвердження адміністративних повноважень у системі.

Для додавання репозиторія з пакетами СЕВДЕІР необхідно закоментувати всі рядки у файлі */etc/apt/sources.list* (вставляючи символ # на початку кожного рядку) та додати наступні нові рядки в кінці файлу:

<pre class="pre-file-1">
    deb http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/ member/
    deb http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/ member/
</pre>

Швидко це зробити можна за допомогою наступних двох команд. Перша додає символ коментування # до кожного непустого рядку, друга додає новий необхідний рядок з посиланням до репозиторію в кінець файлу.

```bash
sudo sed -i 's/^[A-Za-z0-9]/#&/' /etc/apt/sources.list
echo 'deb http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/ member/' | sudo tee -a /etc/apt/sources.list
echo 'deb http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/ member/' | sudo tee -a /etc/apt/sources.list
```

Перевірити результат можна за допомогою текстового редактора nano:

```bash
nano /etc/apt/sources.list
```

![Команди][trembita-test-install-2]

Для виходу з редактору використовується комбінація клавіш “Ctrl + X”. Якщо були внесені зміни, то потрібно натиснути клавішу “Y” для збереження змін, або “N” для відміни.

### 3.4. Додавання GPG ключа для репозиторія {#install-4}

Для встановлення програмного забезпечення з репозиторію СЕВДЕІР потрібно завантажити та додати в систему GPG ключ репозиторію.

Для цього виконайте наступні команди:

```bash
sudo wget -O - http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/pubkey.txt | sudo apt-key add -
sudo wget -O - http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/pubkey.txt | sudo apt-key add -
```

Якщо команда виконана успішно, то буде виведене повідомлення “ОК”.

### 3.5. Додавання облікового запису адміністратора веб-сервісів {#install-5}

Шлюз безпечного обміну використовує локальних користувачів і групи операційної системи для контролю доступу до веб-інтерфейсу адміністрування шлюзу безпечного обміну. Потрібно створити новий обліковий запис, який буде використовуватись для входу в веб-інтерфейс шлюзу безпечного обміну - це обліковий запис адміністратора веб-сервісів з логіном *uxpadmin*.

Для цього виконайте наступні команди:

```bash
sudo useradd -M -N uxpadmin
sudo chsh -s /bin/false uxpadmin
sudo passwd uxpadmin
```

Введіть пароль нового користувача двічі.

### 3.6. Налаштування локалі {#install-6}

В операційній системі шлюзу безпечного обміну має бути встановлена локаль en_US.UTF-8. Для встановлення локалі виконайте наступну команду:

```bash
echo 'LC_ALL=en_US.UTF-8' | sudo tee -a /etc/environment
```

Перезавантажте змінні оточення наступною командою (зверніть увагу на наявність пробілу після першої крапки):

```bash
. /etc/environment
```

### 3.7. Встановлення пакета uxp-securityserver-ua та залежностей {#install-7}

Для встановлення програмного забезпечення UXP Security Server для шлюзу безпечного обміну  використовується команда *apt.* Перед встановленням потрібно оновити список доступних пакетів з репозиторію СЕВДЕІР.

Для встановлення зазначеного програмного забезпечення виконайте наступні команди:

```bash
sudo apt update
sudo apt install -y uxp-securityserver-ua
```

Під час встановлення необхідно ввести ім’я облікового запису (логін) адміністратора веб-сервісів, який буде адмініструвати функціонал шлюзу безпечного обміну - вводимо *uxpadmin*, якого ви створили на шлюзі безпечного обміну на одному з попередніх кроків:

![Конфігурування][trembita-test-install-3]

Цей користувач використовується для входу в веб-інтерфейс адміністрування шлюзу безпечного обміну.

Наступним кроком є внесення параметру використання пам’яті metaspace.

```bash
sudo echo 'SIGNER_PARAMS="${SIGNER_PARAMS} -XX:MaxMetaspaceSize=70m"' >> /etc/uxp/services/local.conf
```

### 3.8. Завантаження ліцензій для шлюзу безпечного обміну {#install-8}

Виконайте команду для перевірки стану виконання встановлених компонентів програмного забезпечення UXP Security Server:

```bash
sudo systemctl list-units | grep "uxp"
```

Список сервісів, які мають бути завантажені (loaded):

<pre class="pre-file-1">
uxp-confclient.service
uxp-jetty.service
uxp-monitor.service
uxp-proxy.service
uxp-signer.service
uxp-uaic.service     (якщо встановлений модуль контролю цілісності)
</pre>

Для роботи компоненту UXP Security Server потрібна діюча ліцензія для тестового середовища. UXP Security Server не працюватиме без діючого файлу ліцензії. Якщо спробуєте відкрити веб-інтерфейс, то побачите сторінку з помилкою "400: Bad Gateway" - ця сторінка відображається сервісом Nginx автоматично, коли UXP Security Server не може бути запущений. 

Файли ліцензії надаються Адміністратором СЕВДЕІР Учаснику разом з файлами якоря конфігурації тестового та промислового середовища (файли configuration anchor) відповідно до Регламенту системи електронної взаємодії державних електронних інформаційних ресурсів.

Завантажте файл ліцензії тестового середовища *member.test.license.lic* до тестового шлюзу безпечного обміну у домашню директорію адміністратора безпеки *secadmin.*

> Примітка. Завантаження файлу ліцензії здійснюється адміністратором локальних компонентів з робочої станції адміністратора за допомогою утиліт, що працюють за протоколом SCP, наприклад, scp або WinSCP.

Змініть назву файлу ліцензії на *license.lic* та перемістіть у наступне місце файлової системи шлюзу безпечного обміну: */etc/uxp/* за допомогою команди:

```bash
sudo mv member.test.license.lic /etc/uxp/license.lic
```

Після установки ліцензії UXP Security Server автоматично визначить наявність файлу з ліцензією і запустить всі необхідні служби (через декілька хвилин, повідомлення веб-інтерфейсу зміниться).

### 3.9. Встановлення підтримки захищених носіїв особистих ключів (апаратних токенів)

Особисті ключі електронної печатки та шифрування знаходяться на захищеному носії особистих ключів (апаратний токен), який необхідно правильно підключити до віртуальної машини шлюзу безпечного обміну.

В першу чергу, підключіть апаратний токен (захищений носій особистих ключів) до фізичного обладнання - сервера, який забезпечує функціонування програмного забезпечення шлюзу безпечного обміну. Якщо використовується система віртуалізації на сервері - налаштуйте адресацію фізичного порту, до якого підключений апаратний токен, до віртуальної машини шлюзу безпечного обміну.

Правильність адресації можна перевірити через наявність інформації про ключі у операційній системі. Введіть наступну команду на шлюзі безпечного обміну:

```bash
sudo dmesg | grep usb
```

![Списки ключів][trembita-test-install-4]

Приклад. З виводу команди видно, що в системі присутні два електронних ключа - Product: IIT E.Key Crystal-1 та  Product: E.Key Almaz-1C відповідно  “Алмаз-1К” та “Кристал-1”.

Для того, щоб шлюз безпечного обміну мав можливість працювати з АЦСК, що видав сертифікати, необхідно додати інформацію про нього у спеціальний файл наступною командою:

```bash
sudo nano /etc/uxp/uac/osplm.ini
```

Знайдіть розділ (у квадратних дужках визначаються розділи) з налаштуваннями CMP-сервісу та встановіть параметри доступу:

<pre class="pre-file-1">
[\SOFTWARE\Institute of Informational Technologies\Certificate Authority-1.3\End User\CMP]
Use=1
CommonName=
Address=ca.informjust.ua
Port=80
</pre>

де у поле *Address* вказуємо адресу до сервісу CMP АЦСК, що видав ваші сертифікати (наприклад, ca.informjust.ua або ca.iit.com.ua). Зазначену адресу може надати ваш надавач електронних довірчих послуг. Також, необхідно встановити параметр *Use=1*.

Приклад результату модифікації файлу:

![Модифікований файл токенів][trembita-test-install-5]

Скопіювати файли підтримки ключів:

```bash
cd
wget http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/pac/signer-uac-plugin-1.0.6.jar
wget -nc http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/pac/signer-uac-plugin-1.0.6.jar
wget http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/pac/EUSignJava.jar
wget -nc http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/pac/EUSignJava.jar
```

Виконати оновлення файлів:

```bash
sudo cp signer-uac-plugin-1.0.6.jar /usr/share/uxp/jlib/addon/signer/
sudo cp EUSignJava.jar /usr/share/uxp/jlib/addon/uac/EUSignJava.jar
```

У випадку, якщо тестове середовище розгорнути у повній відповідності до промислового, виконати наступні команди:

```bash
sudo /usr/share/uxp/uaic/scripts/_uxp-uaic-integritychecker.sh recalc exec
sudo uxp-ua-integritychecker.sh start_all
```

Для ключів ІІТ “Кристал-1” необхідно додатково створити файл:

```bash
sudo nano  /etc/udev/rules.d/80-uxp-iit-e-keys.rules
```

та прописати в ньому правила:

<pre class="pre-file-1">
SUBSYSTEM=="usb", ATTR{idVendor}=="03eb", ATTR{idProduct}=="9301", MODE="0660", GROUP="uxp" 
SUBSYSTEM=="usb", ATTR{idVendor}=="03eb", ATTR{idProduct}=="9308", MODE="0660", GROUP="uxp"
</pre>

Для ключів ІІТ “Алмаз-1К”, Автор “Secure Token 337” та Efit EfitKey необхідно встановити пакети підтримки електронних ключів операційною системою Linux а саме Ubuntu 16.04 Server 64bit:

```bash
sudo apt-get install pcscd libccid pcsc-tools libccid libpcsclite1 opensc
```

Також, для ключів Автор “Secure Token 337” необхідно встановити драйвер для 64-розрядної ОС Linux:

```bash
apt install av337p11d
```

Для використання в якості токену безпеки засіб ІІТ Гряда-301 необхідно до файлу /etc/uxp/uac/osplm.ini додати наступний блок параметрів:

<pre class="pre-file-1">
[\SOFTWARE\Institute of Informational Technologies\Key Medias\NCM Gryada-301]
[\SOFTWARE\Institute of Informational Technologies\Key Medias\NCM Gryada-301\Modules]
[\SOFTWARE\Institute of Informational Technologies\Key Medias\NCM Gryada-301\Modules\001]
OrderNumber=0
SN=001
Address=20.0.0.1
AddressMask=255.0.0.0
</pre>

- 001 - це серійний номер пристрою ІІТ Гряда-301,
- Address - це мережевий адрес пристрою,
- AddressMask - маска підмережі, у якій знаходиться пристрій.

При використанні захищеного носія EfitKey необхідно виконати наступні дії.

Для того щоб додати (включити) існуючий pcsc-пристрій (захищений носій EfitKey) до відповідного списку pcsc-пристроїв, що підтримуються системою, необхідно скорегувати файл Info.plist

```bash
sudo nano /usr/lib/pcsc/drivers/ifd-ccid.bundle/Contents/Info.plist
```

а саме здійснити наступні кроки: 

1. Знайти строку `<key>ifdVendorID</key>` і після елементу `<array>`
додати `<string>0xC1A6</string>`
2. Знайти строку `<key>ifdProductID</key>` і після елементу `<array>`
додати `<string>0x0151</string>`
3. Знайти строку `<key>ifdFriendlyName</key>` і після елементу `<array>`
додати `<string>EfitTechnologies EfitKey</string>`

Скопіювати бібліотеку драйверів libefitkeynxt.so до каталогу /usr/lib:

```bash
wget http://01-03-repo-p-01-n.trembita.gov.ua:82/trembita/pac/libefitkeynxt.so
wget -nc http://02-03-repo-p-02-n.trembita.gov.ua:82/trembita/pac/libefitkeynxt.so
sudo cp libefitkeynxt.so /usr/lib/
```

Для роботи libefitkeynxt.so и EfitKey необхідно мати запущений демон pcscd

Під’єднуємо захищений носій ключової інформації "ЕФІТ КЕЙ" та перевіряємо доступність носія в системі:

```bash
sudo pkcs11-tool -v --list-slots --module /usr/lib/libefitkeynxt.so
```

У випадку, якщо ключ доступний для системи, має бути виведено інформацію про нього. Наприклад:

![Приклад відображення Efit][trembita-test-install-6]

Після проведених дій обов’язково необхідно перезавантажити операційну систему:

```bash
sudo shutdown -r now
```

## 4. Початкова конфігурація

### 4.1. Ініціалізація шлюзу безпечного обміну

Після завантаження ліцензії, за допомогою веб-браузера своєї робочої станції відкрийте веб-інтерфейс шлюзу безпечного обміну - за адресою **`https://<Your-security-server-IP>:4000`**, де `<Your-security-server-IP>` - це IP-адреса шлюзу безпечного обміну.

При першому доступі до веб-інтерфейсу компоненту UXP Security Server може з’явитись попередження про те, що використовується сертифікат, що виданий недовіреним центром сертифікації. При встановленні шлюзу безпечного обміну використовується самопідписаний сертифікат, тому слід додати виняток для цього сертифіката у браузері.

У перші хвилини після перезапуску шлюзу безпечного обміну веб-інтерфейс UXP Security Server може відображати повідомлення “502 Bad Gateway” (зазвичай менше однієї хвилини). Оновлюйте сторінку входу, поки не побачите форму входу.

Увійдіть використовуючи атрибути облікового запису адміністратора веб-сервісів uxpadmin.

<table>
    <tbody>
        <tr>
            <td colspan="2">Власник сервера безпеки<br>(Security Server Owner)</td>
        </tr>
        <tr>
            <td>Клас Учасника<br>(Member Class)</td>
            <td>GOV</td>
        </tr>
        <tr>
            <td>Код Учасника<br>(Member Code)</td>
            <td>У якості кода Учасника використовується код ЄДРПОУ вашої організації. Важливо! Якщо ввести неправильний Member Code, то шлюз безпечного обміну не буде функціонувати коректно і його потрібно буте переінсталювати.</td>
        </tr>
        <tr>
            <td>Ім’я Учасника<br>(Member Name)</td>
            <td>Ім'я Учасника автоматично отримується з сервера реєстру Учасників (після введення кода Учасника) відповідно до заявки на реєстрацію Учасника у СЕВДЕІР.</td>
        </tr>
        <tr>
            <td colspan="2">Сервер безпеки<br>(Security Server)</td>
        </tr>
        <tr>
            <td>Код сервера безпеки<br>(Security Server Code)</td>
            <td>Унікальний код шлюзу безпечного обміну («сервера безпеки» в веб-інтерфейсі) в тестовому середовищі СЕВДЕІР. Вам потрібно створити відповідно до наступного шаблону: MemberCode_SS_T_01, де MemberCode - код ЄДРПОУ організації, 01 - порядковий номер створюваного вами тестового шлюзу безпечного обміну. Зверніть увагу, що _SS_T_ потрібно вводити великими латинськими літерами з використанням символу нижнього підкреслення _.</td>
        </tr>
        <tr>
            <td colspan="2">Токен програмного забезпечення<br>(Software Token)</td>
        </tr>
        <tr>
            <td>PIN</td>
            <td>Вам необхідно придумати PIN-код, який буде використаний для захисту ключів автентифікації, що зберігаються у програмному токені (файловій системі шлюзу безпечного обміну). Важливо! Адміністратор веб-сервісів має зберігати PIN-код у безпечному місці, оскільки після втрати PIN-коду необхідно відновлювати токен, повторно видавати та реєструвати новий сертифікат автентифікації. Для тестового шлюзу безпечного обміну можете використовувати будь-який PIN-код. </td>
        </tr>
        <tr>
            <td>Повторити PIN</td>
            <td>Введіть повторно значення PIN-коду</td>
        </tr>
    </tbody>
</table>

Після введення інформації натисніть «Відправити» (Submit). Ініціалізація може зайняти декілька хвилин. Коли побачите повідомлення про те, що сервер був ініціалізований, натисніть “OK”.

### 4.2. Введення PIN-коду програмного токену

ПЗ UXP Security Server прив’язує всі особисті ключі до токенів безпеки. Після ініціалізації з’явиться помаранчеве повідомлення у верхній частині сторінки з написом "Будь-ласка, введіть PIN-код програмного токену". Це повідомлення вказує, що зазначений токен безпеки в даний час заблокований, а особисті ключі не можуть бути використані. Кожен раз, при перезавантаженні ПЗ UXP Security Server або всієї операційної системи шлюзу безпечного обміну, потрібно увійти (ввести PIN-код) в токен безпеки (в усі використовувані токени безпеки).

Увійдіть в програмний токен безпеки, використовуючи PIN-код, введений під час ініціалізації сервера.

![Інтерфейс ШБО токенів][trembita-test-install-7]

<pre class="pre-algo-1">
1. Перейдіть в розділ "Ключі та сертифікати".
2. Знайдіть рядок із написом "Токен: softToken-0".
3. Натисніть "Введіть PIN-код" в цьому рядку. Відкриється діалогове вікно для введення PIN-коду.
4. Введіть PIN-код та натисніть “OK”.
</pre>

Якщо все зроблено правильно, повідомлення «Будь-ласка, введіть PIN-код програмного токену» має зникнути. Повинна з’явитись кнопка «Вихід» замість кнопки «Введіть PIN-код».

### 4.3. Налаштування сервера позначок часу

UXP Security Server використовує зовнішню службу встановлення позначок часу (timestamping) для встановлення позначок часу на кожне повідомлення. Середовище СЕВДЕІР може мати декілька довірених служб позначок часу. Адміністратор веб-сервісів шлюзу безпечного обміну може обрати, які служби позначок часу будуть використовуватися даним шлюзом безпечного обміну (зазвичай, це служба, створена відповідним надавачем електронних довірчих послуг, у якого ви отримали сертифікати печатки та шифрування).

Додайте цю службу в список служб timestamping, використовуваних шлюзом безпечного обміну.

<pre class="pre-algo-1">
1. Перейдіть в розділ "Параметри системи". Список серверів позначок часу має бути порожній ("Немає (відповідних) записів").
2. Натисніть "Додати" в секції "Сервіси позначки часу".
3. Виберіть зі списку доступний сервіс і натисніть на нього.
4. Натисніть "OK".
</pre>

В результаті відобразиться інформація про обраний сервіс позначок часу і його URL в секції «Сервіси позначки часу».

## 5. Реєстрація шлюзу безпечного обміну

Далі необхідно зареєструвати шлюз безпечного обміну у тестовому середовищі СЕВДЕІР. При цьому, організація вже повинна бути зареєстрованим Учасником СЕВДЕІР.

### 5.1. Імпорт ключа підпису та шифрування для власника шлюзу безпечного обміну

Шлюз безпечного обміну накладає електронну печатку на кожне повідомлення (здійснює його підписання), що відправляється до іншого шлюзу безпечного обміну через СЕВДЕІР. Підписання здійснюється з використанням кваліфікованого сертифікату електронної печатки, який ви отримали на підготовчих кроках від вашого кваліфікованого надавача електронних довірчих послуг.

Для налаштування використання криптографічних ключів та сертифікатів печатки та шифрування на шлюзі безпечного обміну потрібно мати згенеровані ключі печатки та шифрування та відповідні сертифікати, видані одним з кваліфікованих надавачів електронних довірчих послуг (або акредитованим центром сертифікації ключів - далі АЦСК). Цей крок з отримання сертифікатів виконується на підготовчому етапі підключення до СЕВДЕІР. Ключі електронної печатки та шифрування можуть зберігатися на захищених носіях особистих ключів, які повинні бути підключені та налаштовані згідно розділу 3.9.

З метою забезпечення коректного використання сертифікатів необхідно додати (перевірити наявність та коректність) адресу CMP-серверу відповідного АЦСК у конфігурації шлюзу безпечного обміну. Відкриваємо на редагування файл налаштувань:

```bash
sudo nano /etc/uxp/uac/osplm.ini
```

Знайдіть розділ з налаштуваннями CMP-сервісу та встановіть параметри доступу:

<pre class="pre-file-1">
[\SOFTWARE\Institute of Informational Technologies\Certificate Authority-1.3\End User\CMP]
Use=1
CommonName=
Address=ca.informjust.ua
Port=80
</pre>

- у поле Address вказуємо адресу до сервісу CMP АЦСК, що видав ваші сертифікати (наприклад, ca.informjust.ua або ca.iit.com.ua). Зазначену адресу може надати ваш кваліфікований надавач електронних довірчих послуг. Також, встановити параметр Use=1.

Приклад результату модифікація файлу:

![osplm.ini][trembita-test-install-8]

Зберігаємо файл (Ctrl+O, Enter, Ctrl+X). Після цього необхідно перезапустити службу UXP Signer:

```bash
sudo service uxp-signer restart
```

Якщо використовується програмний (файловий) контейнер для зберігання особистих ключів електронної печатки та шифрування (для тестового шлюзу безпечного обміну), їх необхідно підготовити для імпорту на шлюз. Для цього помістіть файл особистого ключа (зазвичай, це Key-6.dat) та обидва сертифікати (печатки та шифрування) у ZIP-архів, без вкладення файлів у директорію. Зазначені файли повинні мати лише латинські літери та цифри у найменуванні.

Примітка. Для програмних (файлових) ключів та сертифікатів від АЦСК ТОВ «ЦСК «Україна» необхідно перед створенням зазначеного вище ZIP-архіву файл з особистим ключем (має розширення файлу .ZS2) перейменувати до Key-6.dat, а файлам сертифікатів (мають розширення файлу .CRT) змінити розширення файлу до .CER.

<pre class="pre-algo-1">
1. Перейдіть в розділ «Ключі і сертифікати».
2. Натисніть кнопку «Додати файл токену».
3. У вікні «Додати файл токену» оберіть значення параметру «Тип файлу токена» - DSTU4145 Token (ZIP containing Key-6.dat and DER-encoded certificates).
4. У поле «ID файлу токена» введіть зрозумілий ідентифікатор, наприклад uaToken.
5. Натисніть кнопку «Переглянути» та оберіть з файлової системи вашої робочої станції ZIP-архів з ключем та сертифікатами.
6. Введіть коректний PIN-код особистого ключа, що знаходиться у файлі ZIP-архіву, у поле PIN та натисніть кнопку ОК.
</pre>

![Додати файл токену][trembita-test-install-9]

Імпортуйте свої ключі електронної печатки та шифрування на шлюз безпечного обміну. У веб-інтерфейсі шлюзу безпечного обміну виконайте наступні дії:

<pre class="pre-algo-1">
1. Перейдіть в розділ "Ключі і сертифікати".
2. Введіть PIN-код до сховища ключів uacToken (це PIN-код до особистого ключа, що імпортований з ZIP-архіву).
3. Навпроти кожного сертифікату натисніть кнопку "Імпортувати", щоб імпортувати відповідні сертифікати.
</pre>

### 5.2. Створення ключа автентифікації для UXP Security Server

Шлюз безпечного обміну повинен автентифікуватися при відправці повідомлень до інших шлюзів безпечного обміну. Сертифікат автентифікації використовується для перевірки автентичності шлюзу безпечного обміну.

З метою отримання сертифікату автентифікації вам необхідно зробити декілька кроків, перший з них - створити новий ключ автентифікації у веб-інтерфейсі шлюзу безпечного обміну.

<pre class="pre-algo-1">
1. Перейдіть в розділ "Ключі і сертифікати".
2. Виберіть токен "softToken-0" натиснувши на ньому мишкою.
3. Натисніть кнопку "Генерувати ключ".
4. Введіть позначку для ключа автентифікації. Рекомендуємо ввести позначку authKey.
5. Натисніть "OK". Генерація ключа може зайняти кілька секунд.
</pre>

Якщо все зроблено вірно, з’явиться ключ, який ви тільки що створили під токеном безпеки з написом authKey (?).

### 5.3 Генерація запиту на сертифікат (Certificate Signing Request (CSR)) для ключа автентифікації

Сертифікати автентифікації, які використовуються шлюзами безпечного обміну, повинні бути підписані технологічним центром сертифікації ключів СЕВДЕІР відповідного середовища (тестового або промислового). Для цього спочатку створіть запит на підпис сертифікату (Certificate Signing Request (CSR)) для щойно створеного ключа через веб-інтерфейс шлюзу безпечного обміну. Центр сертифікації приймає заявки на підпис у вигляді файлів в текстовому форматі PEM. У веб-інтерфейсі шлюзу безпечного обміну:

<pre class="pre-algo-1">
1. Перейдіть в розділ "Ключі і сертифікати".
2. Виберіть ключ автентифікації, згенерований на попередньому кроці (authKey).
3. Натисніть кнопку "Генерувати CSR". Відкриється діалог "Створити запит на підпис сертифіката".
4. У діалоговому вікні встановіть наступні значення:
</pre>

<table>
    <thead>
        <th>
            <td>Поле</td>
            <td>Значення</td>
        </th>
    <thead>
    <tbody>
        <tr>
            <td>Використання<br>(Usage)</td>
            <td><b>Auth</b></td>
        </tr>
        <tr>
            <td>Сервіс сертифікації<br>(Certification Service)</td>
            <td>Виберіть технологічний центр сертифікації ключів середовища СЕВДЕІР («Trembita CA TEST»)</td>
        </tr>
        <tr>
            <td>CSR Format</td>
            <td>PEM</td>
        </tr>
    </tbody>
</table>

[trembita-test-install-1]: /assets/images/trembita-test-install-1.png  "Logo Title Text 2"
[trembita-test-install-2]: /assets/images/trembita-test-install-2.png  "Logo Title Text 2"
[trembita-test-install-3]: /assets/images/trembita-test-install-3.png  "Logo Title Text 2"
[trembita-test-install-4]: /assets/images/trembita-test-install-4.png  "Logo Title Text 2"
[trembita-test-install-5]: /assets/images/trembita-test-install-5.png  "Logo Title Text 2"
[trembita-test-install-6]: /assets/images/trembita-test-install-6.png  "Logo Title Text 2"
[trembita-test-install-7]: /assets/images/trembita-test-install-7.png  "Logo Title Text 2"
[trembita-test-install-8]: /assets/images/trembita-test-install-8.png  "Logo Title Text 2"
[trembita-test-install-9]: /assets/images/trembita-test-install-9.png  "Logo Title Text 2"
